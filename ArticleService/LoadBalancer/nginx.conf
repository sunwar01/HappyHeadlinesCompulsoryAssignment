worker_processes auto;
events { worker_connections 1024; }
http {
  upstream article_service_pool {
    server article-service-1:8080;
    server article-service-2:8080;
    server article-service-3:8080;
  }
  upstream comment_service_pool {
    server comment-service-1:8080;
    server comment-service-2:8080;
    server comment-service-3:8080;
  }
  upstream subscriber_service_pool {
    server subscriber-service-1:8080;
    server subscriber-service-2:8080;
    server subscriber-service-3:8080;
  }
  upstream newsletter_service_pool {
    server newsletter-service-1:8080;
  }

  server {
    listen 8080;

    # --- Swagger ---
    location = /swagger { return 301 /swagger/; }
    location /swagger/ { proxy_pass http://article_service_pool/swagger/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }

    location = /swagger-comments { return 301 /swagger-comments/; }
    location /swagger-comments/ { proxy_pass http://comment_service_pool/swagger/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }

    location = /swagger-subscribers { return 301 /swagger-subscribers/; }
    location /swagger-subscribers/ { proxy_pass http://subscriber_service_pool/swagger/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }

    location = /swagger-newsletter { return 301 /swagger-newsletter/; }
    location /swagger-newsletter/ { proxy_pass http://newsletter_service_pool/swagger/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }

    # --- APIs: ROUTE BY RESOURCE NAME ---

    # 1. SUBSCRIBER ENDPOINTS: /api/*/Subscribers/...
    location ~* ^/api/[^/]+/Subscribers {
      proxy_pass http://subscriber_service_pool;
      proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 2. COMMENT ENDPOINTS: /api/*/articles/*/comments
    location ~* ^/api/[^/]+/articles/[0-9a-fA-F-]+/comments {
      proxy_pass http://comment_service_pool;
      proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 3. NEWSLETTER
    location ~* ^/api/newsletter {
      proxy_pass http://newsletter_service_pool;
      proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 4. ARTICLE ENDPOINTS: /api/*/Articles, /api/*/Articles/{id}, etc.
    location ~* ^/api/[^/]+/Articles {
      proxy_pass http://article_service_pool;
      proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 5. FALLBACK: ALL OTHER /api/* â†’ ARTICLE (health, etc.)
    location /api/ {
      proxy_pass http://article_service_pool;
      proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 6. ROOT & HEALTH
    location / {
      proxy_pass http://article_service_pool;
      proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme;
    }
  }
}